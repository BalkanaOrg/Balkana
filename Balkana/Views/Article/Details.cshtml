@model Balkana.Data.Models.Article

@using System.Text.RegularExpressions
@{
    // Format title: ArticleTitle - Balkana News (similar to teams/tournaments)
    ViewData["Title"] = $"{Model.Title} - Balkana News";
    
    // Strip HTML tags from content for description
    var plainText = Regex.Replace(Model.Content ?? "", "<.*?>", string.Empty);
    plainText = System.Net.WebUtility.HtmlDecode(plainText);
    plainText = plainText.Replace("&nbsp;", " ").Trim();
    // Clean up multiple spaces
    plainText = Regex.Replace(plainText, @"\s+", " ");
    
    ViewData["Description"] = plainText.Length > 160 ? plainText.Substring(0, 160) + "..." : plainText;
    ViewData["Keywords"] = $"Balkana, esports, {Model.Title}, gaming news, tournament news";
    
    var baseUrl = Context.Request.Scheme + "://" + Context.Request.Host;
    var articleUrl = baseUrl + Context.Request.Path;
    var imageUrl = Model.ThumbnailUrl.StartsWith("http") ? Model.ThumbnailUrl : baseUrl + Model.ThumbnailUrl;
    
    // Set article thumbnail for Open Graph/Twitter Card
    var articleImage = !string.IsNullOrEmpty(Model.ThumbnailUrl) 
        ? (Model.ThumbnailUrl.StartsWith("http") ? Model.ThumbnailUrl : baseUrl + Model.ThumbnailUrl)
        : baseUrl + "/Balkana.png";
    ViewData["Image"] = articleImage;
    
    var authorName = $"{Model.Author.FirstName} {Model.Author.LastName}";
}

<!-- Article Structured Data (JSON-LD) -->
<script type="application/ld+json">
{
    "@@context": "https://schema.org",
    "@@type": "NewsArticle",
    "headline": "@Html.Raw(Model.Title.Replace("\"", "\\\""))",
    "description": "@Html.Raw((plainText.Length > 200 ? plainText.Substring(0, 200) + "..." : plainText).Replace("\"", "\\\"").Replace("\r", "").Replace("\n", " "))",
    "image": "@imageUrl",
    "datePublished": "@Model.PublishedAt?.ToString("yyyy-MM-ddTHH:mm:ssZ")",
    "dateModified": "@Model.CreatedAt.ToString("yyyy-MM-ddTHH:mm:ssZ")",
    "author": {
        "@@type": "Person",
        "name": "@authorName"
    },
    "publisher": {
        "@@type": "Organization",
        "name": "Balkana",
        "logo": {
            "@@type": "ImageObject",
            "url": "@(baseUrl)/Balkana.png"
        }
    },
    "mainEntityOfPage": {
        "@@type": "WebPage",
        "@@id": "@articleUrl"
    }
}
</script>

<!-- Breadcrumb Structured Data (JSON-LD) -->
<script type="application/ld+json">
{
    "@@context": "https://schema.org",
    "@@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "@baseUrl"
        },
        {
            "@@type": "ListItem",
            "position": 2,
            "name": "News",
            "item": "@(baseUrl)/Article"
        },
        {
            "@@type": "ListItem",
            "position": 3,
            "name": "@Html.Raw(Model.Title.Replace("\"", "\\\""))",
            "item": "@(baseUrl)@Context.Request.Path"
        }
    ]
}
</script>

<div class="article-detail-page">
    <div class="article-detail-container">
        <nav aria-label="breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                <li class="breadcrumb-item"><a asp-controller="Article" asp-action="Index">News</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
            </ol>
        </nav>

        <article class="article-detail" itemscope itemtype="https://schema.org/NewsArticle">
            <header class="article-detail-header">
                <h1 class="article-detail-title" itemprop="headline">@Model.Title</h1>
                <div class="article-detail-meta">
                    <div class="article-meta-item">
                        <i class="fi fi-rr-user"></i>
                        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
                            <span itemprop="name">@Model.Author.FirstName @Model.Author.LastName</span>
                        </span>
                    </div>
                    <div class="article-meta-item">
                        <i class="fi fi-rr-calendar"></i>
                        <time itemprop="datePublished" datetime="@Model.PublishedAt?.ToString("yyyy-MM-ddTHH:mm:ssZ")">
                            @Model.PublishedAt?.ToString("MMMM dd, yyyy")
                        </time>
                    </div>
                    @if (User.IsInRole("Editor"))
                    {
                        <div class="article-meta-actions">
                            <form asp-action="Unpublish" asp-route-id="@Model.Id" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn-action btn-action-secondary">
                                    <i class="fi fi-rr-lock"></i>
                                    Unpublish
                                </button>
                            </form>
                            <form asp-action="Delete" asp-route-id="@Model.Id" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn-action btn-action-danger">
                                    <i class="fi fi-rr-trash"></i>
                                    Delete
                                </button>
                            </form>
                        </div>
                    }
                </div>
            </header>

            @if (!string.IsNullOrEmpty(Model.ThumbnailUrl))
            {
                <div class="article-detail-image">
                    <img src="@Model.ThumbnailUrl" alt="@Model.Title" itemprop="image" loading="lazy" />
                </div>
            }

            <div class="article-detail-body" itemprop="articleBody">
                @Html.Raw(Model.Content)
            </div>
        </article>
    </div>
</div>
