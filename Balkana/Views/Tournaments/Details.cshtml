@using Balkana.Data.Models
@model Balkana.Data.Models.Tournament

@{
    ViewData["Title"] = "Tournament Details";
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<h2>@Model.FullName (@Model.ShortName)</h2>

<div class="mb-4">
    <dl class="row">
        <dt class="col-sm-3">Organizer</dt>
        <dd class="col-sm-9">@Model.Organizer?.FullName</dd>

        <dt class="col-sm-3">Game</dt>
        <dd class="col-sm-9">@Model.Game?.FullName</dd>

        <dt class="col-sm-3">Description</dt>
        <dd class="col-sm-9">@Model.Description</dd>

        <dt class="col-sm-3">Dates</dt>
        <dd class="col-sm-9">
            @(
                Model.StartDate.ToString("d") == Model.EndDate.ToString("d")
                ? Model.StartDate.ToShortDateString()
                : Model.StartDate.ToString("d") + " - " + Model.EndDate.ToString("d")
                )
        </dd>
    </dl>
</div>

<h3>Series</h3>
@if (Model.Series != null && Model.Series.Any())
{
    <ul class="list-group mb-4">
        @foreach (var s in (List<Series>)ViewData["OrderedSeries"])
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>@s.Name</span>
                <span>@(s.TeamA?.FullName ?? "TBD") vs @(s.TeamB?.FullName ?? "TBD")</span>
            </li>
        }
    </ul>
}
else
{
    <p>No series added yet.</p>
}

<h3>Bracket</h3>
@if (!Model.Series.Any())
{
    <form asp-action="GenerateBracket" method="post">
        <input type="hidden" name="tournamentId" value="@Model.Id" />
        <button type="submit" class="btn btn-success mb-3">Generate Bracket</button>
    </form>
}
<h3>Bracket</h3>
<div id="bracket-container" class="brackets-viewer" style="width: 100%; height: 800px;"></div>

<link rel="stylesheet" href="https://unpkg.com/brackets-viewer/dist/brackets-viewer.min.css" />
<script src="https://unpkg.com/brackets-viewer/dist/brackets-viewer.min.js"></script>

<script>
    (async function() {
        try {
            const res = await fetch(`/api/tournaments/@Model.Id/bracket`);
            const data = await res.json();
            console.log("🎯 Bracket data:", data);
            console.log("Participants:", data.participants);
            console.log("Matches:", data.matches);

            await bracketsViewer.render(
                {
                    stages: data.stages,
                    matches: data.matches,
                    matchGames: data.matchGames,
                    participants: data.participants,
                },
                {
                    selector: '#bracket-container',
                    orientation: 'horizontal',
                }
            );

        } catch (err) {
            console.error("⚠️ Bracket rendering error:", err);
        }
    })();
</script>

<h4>Participating Teams</h4>
<div class="d-flex flex-wrap">
    @foreach (var team in (List<Team>)ViewData["ParticipatingTeams"])
    {
        var players = team.Players.Take(5).ToList();
        <div class="team-card m-2 position-relative text-center">

            <img src="@team.LogoURL" class="team-logo card-img-top" alt="@team.FullName" />

            <div class="team-players position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center">
                @if (players.Any())
                {
                    @foreach (var p in players)
                    {
                        <small class="player-name">@p.Nickname</small>
                    }
                }
                else
                {
                    <small class="text-muted">No players</small>
                }
            </div>

            <div class="card-body p-1">
                <small>@team.FullName</small>
            </div>
        </div>
    }
</div>

<style>
    /* Container adjustments */
    #bracket-container.brackets-viewer {
        background-color: #12121b; !important; /* your dark background */
        color: black;
        padding: 20px;
        overflow-x: auto;
    }

    /* Individual brackets */
    .bracket-ub, .bracket-lb, .bracket-gf {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Matches */
    .match {
        min-width: 140px;
        background-color: #1e1e2f !important; /* dark match background */
        color: black; /* text color */
        border: 1px solid #333; /* subtle border */
        border-radius: 6px;
        padding: 5px;
        font-size: 0.9rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    /* Team/participant names */
    .participant {
        color: #fff;
        font-weight: 500;
        background-color: #12121b !important;
    }

        /* Optional hover highlight */
    #bracket-container.brackets-viewer .participant.hover
    {
        background: #32324a !important;
        border-radius: 4px;
    }

    /* Scores */
    .score {
        color: #f0c040;
        font-weight: bold;
    }

    /* Connector lines */
    .connector {
        stroke: #888; /* gray lines */
        stroke-width: 2;
    }

    /* Make brackets scrollable horizontally */
    #bracket-container {
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
    }

    /* Smaller gap between columns if too wide */
    .bracket-column {
        gap: 10px;
    }

    .team-card {
        cursor: pointer;
        overflow: hidden;
        position: relative;
        width: 120px;
        height: 150px;
        display: flex;
        flex-direction: column;
    }

    .team-logo {
        position: relative; /* <-- add this */
        width: 100%;
        height: 100px;
        object-fit: contain;
        z-index: 1; /* stays below overlay */
    }

    .team-card .team-players {
        display: none !important; /* hidden by default */
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100px;
        z-index: 2; /* above logo */
        background-color: #1e1e2f;
        color: white;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .team-card:hover .team-logo {
        display: none !important;
    }

    .team-card:hover .team-players {
        display: flex !important;
    }
</style>
