@using Balkana.Services.Brandings.Models
@model BrandingFormModel
@{
    ViewData["Title"] = "Add Branding";
}

<div class="team-form-container">
    <div class="form-header">
        <h2>Create Branding</h2>
        <p>Set up a new branding organization with a polished logo and key details.</p>
    </div>

    <div class="form-card">
        <form method="post" enctype="multipart/form-data" class="team-form row g-4">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="col-lg-8">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label asp-for="FullName" class="form-label">Brand Name *</label>
                                <input asp-for="FullName" class="form-control" placeholder="Full organization name" required />
                                <span asp-validation-for="FullName" class="text-danger small"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Tag" class="form-label">Tag *</label>
                                <input asp-for="Tag" class="form-control" placeholder="3-5 letters" required />
                                <span asp-validation-for="Tag" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="YearFounded" class="form-label">Founded</label>
                                <input asp-for="YearFounded" class="form-control" type="number" placeholder="YYYY" required />
                                <span asp-validation-for="YearFounded" class="text-danger small"></span>
                            </div>

                            <div class="col-md-8">
                                <label asp-for="FounderName" class="form-label">Founder</label>
                                <div class="user-search-container">
                                    <input type="text" 
                                           id="founderSearch" 
                                           class="form-control user-search-input" 
                                           placeholder="Search for founder by username, email, or name..."
                                           autocomplete="off" />
                                    <input type="hidden" asp-for="FounderId" id="founderId" />
                                    <input type="hidden" asp-for="FounderName" id="founderName" />
                                    <div id="founderResults" class="user-search-results" style="display: none;"></div>
                                </div>
                                <span asp-validation-for="FounderId" class="text-danger small"></span>
                            </div>

                            <div class="col-md-8">
                                <label asp-for="ManagerName" class="form-label">Manager</label>
                                <div class="user-search-container">
                                    <input type="text" 
                                           id="managerSearch" 
                                           class="form-control user-search-input" 
                                           placeholder="Search for manager by username, email, or name..."
                                           autocomplete="off" />
                                    <input type="hidden" asp-for="ManagerId" id="managerId" />
                                    <input type="hidden" asp-for="ManagerName" id="managerName" />
                                    <div id="managerResults" class="user-search-results" style="display: none;"></div>
                                </div>
                                <span asp-validation-for="ManagerId" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column gap-3">
                        <div>
                            <label asp-for="LogoFile" class="form-label">Brand Logo</label>
                            <div class="logo-upload" id="brand-logo-upload">
                                <input asp-for="LogoFile" type="file" class="form-control" accept="image/*" id="LogoFileInput" />
                                <div class="upload-hint small text-muted mt-1">
                                    WebP on save; recommend square up to 512px, ~5MB max.
                                </div>
                                <div class="logo-preview mt-3" style="display:none;">
                                    <img id="logoPreviewImg" class="img-fluid rounded border" style="max-height:180px; object-fit:contain;" />
                                    <div class="text-muted small mt-1">Preview</div>
                                </div>
                            </div>
                            <span asp-validation-for="LogoFile" class="text-danger small"></span>
                        </div>

                        <div class="d-flex gap-2 mt-auto">
                            <a asp-action="Index" class="btn btn-outline-secondary flex-grow-1">Cancel</a>
                            <button type="submit" class="btn btn-primary flex-grow-1">Create Branding</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    .team-form-container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 10px;
    }
    .team-form-container .form-header h2 {
        margin-bottom: 4px;
    }
    .team-form-container .form-header p {
        margin: 0 0 12px;
        color: #a7acb7;
    }
    .team-form-container .form-card {
        background: linear-gradient(145deg, #111722, #0c1018);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 18px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.35);
    }
    .team-form .card {
        background: #0f141d;
        border: 1px solid rgba(255,255,255,0.06);
    }
    .team-form .form-label {
        font-weight: 600;
        color: #dfe3ea;
    }
    .team-form .form-control,
    .team-form .form-select {
        background: #121826;
        border-color: rgba(255,255,255,0.08);
        color: #e5e8ef;
    }
    .team-form .form-control:focus,
    .team-form .form-select:focus {
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        border-color: #0d6efd;
    }
    .logo-upload input[type="file"] {
        background: #121826;
        color: #e5e8ef;
    }
    .btn-primary {
        background: linear-gradient(135deg, #1b6ef3, #3b8dff);
        border: none;
    }
    .btn-primary:hover {
        filter: brightness(1.05);
    }
    .user-search-container {
        position: relative;
    }
    .user-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #1a1f2e;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 4px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .user-search-result-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        color: #e5e8ef;
    }
    .user-search-result-item:hover {
        background: #252a3a;
    }
    .user-search-result-item:last-child {
        border-bottom: none;
    }
    .user-search-result-item strong {
        color: #fff;
        display: block;
        margin-bottom: 2px;
    }
    .user-search-result-item small {
        color: #a7acb7;
        display: block;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.getElementById('LogoFileInput');
        const previewWrapper = document.querySelector('.logo-preview');
        const previewImg = document.getElementById('logoPreviewImg');

        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files?.[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        previewImg.src = ev.target?.result;
                        previewWrapper.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewWrapper.style.display = 'none';
                    previewImg.src = '';
                }
            });
        }

        // User search functionality
        setupUserSearch('founder', 'Founder');
        setupUserSearch('manager', 'Manager');
    });

    function setupUserSearch(prefix, label) {
        const searchInput = document.getElementById(prefix + 'Search');
        const resultsDiv = document.getElementById(prefix + 'Results');
        const hiddenIdInput = document.getElementById(prefix + 'Id');
        const hiddenNameInput = document.getElementById(prefix + 'Name');
        let searchTimeout;

        searchInput.addEventListener('input', function() {
            const query = this.value.trim();

            clearTimeout(searchTimeout);

            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                hiddenIdInput.value = '';
                hiddenNameInput.value = '';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`/api/Search/users?query=${encodeURIComponent(query)}&limit=10`)
                    .then(response => response.json())
                    .then(users => {
                        if (users.length === 0) {
                            resultsDiv.innerHTML = '<div class="user-search-result-item">No users found</div>';
                            resultsDiv.style.display = 'block';
                            return;
                        }

                        resultsDiv.innerHTML = users.map(user => `
                            <div class="user-search-result-item" data-user-id="${user.id}" data-user-name="${user.userName}">
                                <strong>${user.userName}</strong>
                                ${user.firstName || user.lastName ? `<small>${(user.firstName || '') + ' ' + (user.lastName || '')}</small>` : ''}
                                <small>${user.email}</small>
                            </div>
                        `).join('');

                        // Add click handlers
                        resultsDiv.querySelectorAll('.user-search-result-item').forEach(item => {
                            item.addEventListener('click', function() {
                                const userId = this.getAttribute('data-user-id');
                                const userName = this.getAttribute('data-user-name');
                                
                                hiddenIdInput.value = userId;
                                hiddenNameInput.value = userName;
                                searchInput.value = userName;
                                resultsDiv.style.display = 'none';
                            });
                        });

                        resultsDiv.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error searching users:', error);
                        resultsDiv.style.display = 'none';
                    });
            }, 300);
        });

        // Hide results when clicking outside
        document.addEventListener('click', function(event) {
            if (!searchInput.contains(event.target) && !resultsDiv.contains(event.target)) {
                resultsDiv.style.display = 'none';
            }
        });
    }
</script>

