@model Balkana.Models.Store.CheckoutViewModel

@{
    ViewData["Title"] = "Checkout";
}

<div class="container mt-4 text-white">
    <h2 class="mb-4 text-white"><i class="fas fa-lock"></i> Secure Checkout</h2>

    <div class="row">
        <!-- Checkout Form -->
        <div class="col-md-8">
            <form asp-action="Checkout" method="post">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                <!-- Customer Information -->
                <div class="card bg-dark border-primary mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">1. Customer Information</h5>
                    </div>
                    <div class="card-body text-white">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FirstName" class="form-label"></label>
                                <input asp-for="FirstName" class="form-control bg-dark text-white border-secondary" required />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="LastName" class="form-label"></label>
                                <input asp-for="LastName" class="form-control bg-dark text-white border-secondary" required />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Email" class="form-label"></label>
                                <input asp-for="Email" class="form-control bg-dark text-white border-secondary" type="email" required />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Phone" class="form-label"></label>
                                <input asp-for="Phone" class="form-control bg-dark text-white border-secondary" placeholder="+359..." required />
                                <span asp-validation-for="Phone" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="card bg-dark border-info mb-3">
                    <div class="card-header bg-info text-dark">
                        <h5 class="mb-0">2. Shipping Address</h5>
                    </div>
                    <div class="card-body text-white">
                        <div class="mb-3">
                            <label asp-for="ShippingAddress" class="form-label"></label>
                            <input asp-for="ShippingAddress" class="form-control bg-dark text-white border-secondary" required />
                            <span asp-validation-for="ShippingAddress" class="text-danger"></span>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ShippingCity" class="form-label"></label>
                                <input asp-for="ShippingCity" class="form-control bg-dark text-white border-secondary" required />
                                <span asp-validation-for="ShippingCity" class="text-danger"></span>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label asp-for="ShippingPostalCode" class="form-label"></label>
                                <input asp-for="ShippingPostalCode" class="form-control bg-dark text-white border-secondary" />
                                <span asp-validation-for="ShippingPostalCode" class="text-danger"></span>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label asp-for="ShippingCountry" class="form-label"></label>
                                <select asp-for="ShippingCountry" asp-items="Model.Countries" class="form-select bg-dark text-white border-secondary" required></select>
                                <span asp-validation-for="ShippingCountry" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delivery Method -->
                <div class="card bg-dark border-warning mb-3">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">3. Delivery Method</h5>
                    </div>
                    <div class="card-body text-white">
                        <div class="mb-3">
                            <select asp-for="DeliveryProvider" asp-items="Model.DeliveryMethods" class="form-select bg-dark text-white border-secondary" required onchange="toggleOfficeSelection()"></select>
                            <span asp-validation-for="DeliveryProvider" class="text-danger"></span>
                        </div>

                        <!-- Ekont Office Selection -->
                        <div id="ekontOfficeDiv" style="display: none;">
                            <label class="form-label text-white">Select Ekont Office</label>
                            <select asp-for="DeliveryOfficeCode" asp-items="Model.EkontOffices" class="form-select bg-dark text-white border-secondary">
                                <option value="">-- Select Office --</option>
                            </select>
                        </div>

                        <!-- Speedy Office Selection -->
                        <div id="speedyOfficeDiv" style="display: none;">
                            <label class="form-label text-white">Select Speedy Office</label>
                            <select asp-for="DeliveryOfficeCode" asp-items="Model.SpeedyOffices" class="form-select bg-dark text-white border-secondary">
                                <option value="">-- Select Office --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="card bg-dark border-success mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">4. Payment Method</h5>
                    </div>
                    <div class="card-body text-white">
                        <select asp-for="PaymentMethod" asp-items="Model.PaymentMethods" class="form-select bg-dark text-white border-secondary" required></select>
                        <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                        
                        <div class="alert alert-info mt-3">
                            <small>
                                <i class="fas fa-info-circle"></i> 
                                <strong>Cash on Delivery (Наложен платеж)</strong> is available for all orders. 
                                Pay when you receive your package!
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Order Notes -->
                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">Order Notes (Optional)</h6>
                    </div>
                    <div class="card-body text-white">
                        <textarea asp-for="CustomerNotes" class="form-control bg-dark text-white border-secondary" rows="3" placeholder="Special delivery instructions, gift message, etc."></textarea>
                    </div>
                </div>

                <!-- Terms & Conditions -->
                <div class="form-check mb-3">
                    <input asp-for="AcceptTerms" class="form-check-input" type="checkbox" required />
                    <label asp-for="AcceptTerms" class="form-check-label">
                        I agree to the <a href="#" target="_blank">terms and conditions</a>
                    </label>
                    <span asp-validation-for="AcceptTerms" class="text-danger d-block"></span>
                </div>

                <button type="submit" class="btn btn-success btn-lg w-100">
                    <i class="fas fa-check"></i> Place Order
                </button>
            </form>
        </div>

        <!-- Order Summary -->
        <div class="col-md-4">
            <div class="card bg-dark border-primary sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body text-white">
                    <!-- Items List -->
                    @if (Model.Cart != null && Model.Cart.Items != null && Model.Cart.Items.Any())
                    {
                        <div class="mb-3">
                            @foreach (var item in Model.Cart.Items)
                            {
                                <div class="d-flex justify-content-between mb-2 small">
                                    <span>@item.ProductName x@item.Quantity</span>
                                    <span>@item.Total.ToString("F2") BGN</span>
                                </div>
                            }
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>@Model.Cart.SubTotal.ToString("F2") BGN</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span id="shippingCost">@Model.ShippingCost.ToString("F2") BGN</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax (VAT 20%):</span>
                            <span>@Model.Cart.EstimatedTax.ToString("F2") BGN</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Total:</strong>
                            <strong class="h5 mb-0">@((Model.Cart.SubTotal + Model.ShippingCost + Model.Cart.EstimatedTax).ToString("F2")) BGN</strong>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            Cart is empty!
                        </div>
                    }
                </div>
            </div>

            <!-- Security Badge -->
            <div class="card bg-dark border-success mt-3">
                <div class="card-body text-center text-white">
                    <i class="fas fa-shield-alt fa-3x text-success mb-2"></i>
                    <p class="mb-0"><small>Secure SSL encrypted checkout</small></p>
                </div>
            </div>
        </div>
    </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> Your cart is empty!
        </div>
        <a asp-action="Index" class="btn btn-primary">Browse Products</a>
    }
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        function toggleOfficeSelection() {
            const deliveryMethod = document.querySelector('[name="DeliveryProvider"]').value;
            const ekontDiv = document.getElementById('ekontOfficeDiv');
            const speedyDiv = document.getElementById('speedyOfficeDiv');
            
            ekontDiv.style.display = deliveryMethod === '0' ? 'block' : 'none'; // Ekont = 0
            speedyDiv.style.display = deliveryMethod === '1' ? 'block' : 'none'; // Speedy = 1
        }
        
        // Initialize on page load
        toggleOfficeSelection();
    </script>
}

@section Styles {
    <style>
        .card { background-color: #1a1a1a !important; }
        .form-control:focus, .form-select:focus {
            background-color: #2a2a2a;
            color: white !important;
            border-color: #0d6efd;
        }
    </style>
}
